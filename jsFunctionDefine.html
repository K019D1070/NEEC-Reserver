<script type="application/javascript">//<!--
  function detailRegister(elm, date){
    elm.addEventListener("click", elm=>{
      resStatus.display(elm.srcElement, date.date);
    });
  }
  function promisedRun(funcName, ...args){
    return new Promise((resolve, reject)=>{
      let timeAlert = setTimeout(20* 1000, ()=>{
        alert("カレンダーの読み込みに時間がかかっています...");
      });
      let timeout = setTimeout(6* 60* 1000, ()=>{//GASは6分でタイムアウトするため6分以上待ってもダメならダメ
        alert("カレンダーの読み込みに失敗しました\nGoogle App Scriptの障害情報を確認してください。\n特に障害もなく数時間後に試しても状況が改善されない場合、サポートに連絡してください。");
      });
      google.script.run.withSuccessHandler((dates)=>{
        clearTimeout(timeAlert);
        clearTimeout(timeout);
        resolve(dates);
      }).withFailureHandler((error)=>{
        clearTimeout(timeAlert);
        clearTimeout(timeout);
        reject(error);
      })[funcName](...args);
    });
  }
  function statusDisplay(){
    document.getElementsByName("reservation").forEach((canvas)=>{
      canvas.width = canvas.clientWidth*4;
      canvas.height = canvas.clientHeight*4;
      const context = canvas.getContext("2d");

      context.beginPath();
      context.lineWidth = 20;
      switch(canvas.innerHTML){
        case "leeway"://◎
          context.strokeStyle = '#ff0000';
          context.arc(canvas.width/ 2, canvas.height/ 2, (canvas.height-context.lineWidth)/2, 2* Math.PI, 0);
          context.stroke();
          context.beginPath();
          context.arc(canvas.width/ 2, canvas.height/ 2, (canvas.height-context.lineWidth*4)/2, 2* Math.PI, 0);
          context.stroke();
          break;
        case "free"://〇
          context.strokeStyle = '#ff0000';
          context.arc(canvas.width/ 2, canvas.height/ 2, (canvas.height-context.lineWidth)/2, 2* Math.PI, 0);
          context.stroke();
          break;
        case "little"://△
          context.strokeStyle = '#00ff00';
          context.moveTo(canvas.width/2- canvas.height*Math.cos(Math.PI/3), canvas.height-context.lineWidth/2);
          context.lineTo(canvas.width/2, context.lineWidth/2);
          context.lineTo(canvas.width/2+ canvas.height*Math.cos(Math.PI/3), canvas.height-context.lineWidth/2);
          context.lineTo(canvas.width/2- canvas.height*Math.cos(Math.PI/3), canvas.height-context.lineWidth/2);
          context.lineTo(canvas.width/2, context.lineWidth/2);
          context.stroke();
          break;
        case "full"://×
          context.strokeStyle = '#0000ff';
          context.moveTo(canvas.width/2+ canvas.height/2 -context.lineWidth/2, context.lineWidth/2);
          context.lineTo(canvas.width/2- canvas.height/2 +context.lineWidth/2, canvas.height- context.lineWidth/2);
          context.moveTo(canvas.width/2+ canvas.height/2 -context.lineWidth/2, canvas.height- context.lineWidth/2);
          context.lineTo(canvas.width/2- canvas.height/2 +context.lineWidth/2, context.lineWidth/2);
          context.stroke();
          break;
        case "announce"://📢
          context.fillStyle = '#dddd00';
          context.strokeStyle = '#dddd00';
          context.moveTo(canvas.width/2- canvas.height*2/5, canvas.height/2);
          context.lineTo(canvas.width/2- canvas.height*2/5, canvas.height*5/9);
          context.lineTo(canvas.width/2+ canvas.height*0/5, canvas.height*1/3);
          context.lineTo(canvas.width/2+ canvas.height*0/5, canvas.height*2/3);
          context.lineTo(canvas.width/2- canvas.height*2/5, canvas.height*4/9);
          context.lineTo(canvas.width/2- canvas.height*2/5, canvas.height/2);
          context.fill();
          context.stroke();
          context.closePath();
          context.beginPath();
          context.lineWidth = 10;
          context.strokeStyle = '#ff5500';
          context.arc(canvas.width/2, canvas.height/2, canvas.height/6, -Math.PI/4, Math.PI/4);
          context.stroke();
          context.closePath();
          context.beginPath();
          context.arc(canvas.width/2, canvas.height/2, canvas.height/3, -Math.PI/5, Math.PI/5);
          context.stroke();
          context.closePath();
          context.beginPath();
          context.arc(canvas.width/2, canvas.height/2, canvas.height/2, -Math.PI/5, Math.PI/5);
          context.stroke();
          break;
      }
    });
  }
  function load(reserve){
    let months = reserve.dates.months;
    reserve.dates.list.forEach((date)=>{
      let y = date.date.getFullYear();
      let m = date.date.getMonth();
      if(m<10){
        m = String(0)+m;
      }
      if(undefined == months[String(y)+m]){
        months[String(y)+m] = [];
      }
      months[String(y)+m].push(date);
    });
    console.log(reserve);
    calendarObj.genCalendar(reserve.dates.months);
    calendarObj.genHTML(reserve);
    console.log(calendarObj);
    links.innerHTML = calendarObj.genLinks();
  }
  function reload(){
    promisedRun("getReserve").then(reserve=>{
      reserve = JSON.parse(reserve);
      reserve.dates.list.forEach(date=>{
        date.date = new Date(date.date)
      });
      load(reserve);
      calendarObj.calendars.forEach(calendar=>{
        const target = document.getElementById([calendar.id]);
        target.appendChild(calendar.HTML.getElementsByTagName("table")[0]);
        target.getElementsByTagName("table")[0].remove();
      });
      statusDisplay();
    }, error=>{
      Error(error);
    });
  }
//--></script>